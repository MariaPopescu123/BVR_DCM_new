---
title: "Depth_analysis_with_test"
author: "Maria Popescu"
date: "2025-08-16"
output: html_document
---
This for final machine learning analysis. 

before running this script first run
01_DataDownload
03_Datawrangling: then go through all the files within chronologically
then you can run this script

1. now we have determined what the most important drivers are from the Depth_analysis.Rmd. Water level and photic zone are the most important drivers, I will use 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load the packages that you need
```{r}
library(randomForest)
library(missForest)
library(caret)
library(future)
library(here)
```

This data frame has predictor values for DCM depth as well as DCM magnitude. 
Need to split these up for two different analysis

```{r}
full_weekly_data <- read.csv(here("CSVs", "full_weekly_data.csv"))

#print(colnames(full_weekly_data_clean))
depth_analysis <- full_weekly_data |>
  #select(-ends_with("max_val"), -ends_with("min_val"), -ends_with("range"), 
   #      -max_conc, -totals_mean, -totals_med, -N_at_DCM, -Week)|>
  select(Date, DCM_depth, PZ, WaterLevel_m)
```

Split into training and testing

```{r}
library(caret)

set.seed(123)

# Sort by Date
RF_depth_analysis <- depth_analysis[order(depth_analysis$Date), ]

# Example: use 70% earliest data for training, 30% most recent for testing
train_index <- 1:floor(0.7 * nrow(RF_depth_analysis))

train_data <- RF_depth_analysis[train_index, ]
test_data  <- RF_depth_analysis[-train_index, ]
```
tidy up so we don't have NAs for train data or test data while keeping the columns the same
```{r}
# --- Clean train_data ---
train_data <- train_data %>%
  select(where(is.numeric)) %>%   # keep only numeric predictors + target
  mutate(across(everything(), ~ ifelse(is.infinite(.) | is.nan(.), NA, .))) %>%
  select(where(~ mean(is.na(.)) <= 0.25)) %>%
  na.omit()

# --- Clean test_data using same columns as train_data ---
test_dates <- test_data$Date
test_obs   <- test_data$DCM_depth

test_data_clean <- test_data %>%
  select(all_of(colnames(train_data))) %>%
  na.omit()
```
time-series CV
```{r}
control <- trainControl(method = "timeslice",
                        initialWindow = floor(0.7 * nrow(train_data)),
                        horizon = floor(0.3 * nrow(train_data)),
                        fixedWindow = TRUE,
                        savePredictions = "final")

tune_grid <- expand.grid(mtry = c(3, 6, 9, 12))

rf_caret <- train(
  DCM_depth ~ .,
  data = train_data,
  method = "rf",
  metric = "RMSE",
  trControl = control,
  tuneGrid = tune_grid,
  ntree = 500
)

print(rf_caret)
```
```{r}
# Predict on test set
preds <- predict(rf_caret$finalModel, newdata = test_data)

# Use variability across trees to estimate uncertainty
all_tree_preds <- predict(rf_caret$finalModel, newdata = test_data, predict.all = TRUE)
pred_matrix <- all_tree_preds$individual
pred_mean <- rowMeans(pred_matrix)
pred_sd   <- apply(pred_matrix, 1, sd)

plot_df <- data.frame(
  Date = test_data$Date,
  Observed = test_data$DCM_depth,
  Predicted = pred_mean,
  Lower = pred_mean - 1.96 * pred_sd,
  Upper = pred_mean + 1.96 * pred_sd
)

library(ggplot2)
ggplot(plot_df, aes(x = Date)) +
  geom_line(aes(y = Observed, color = "Observed"), size = 1) +
  geom_line(aes(y = Predicted, color = "Predicted"), size = 1, linetype = "dashed") +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), fill = "blue", alpha = 0.2) +
  labs(title = "Random Forest Forecast with Uncertainty",
       y = "DCM Depth",
       color = "") +
  theme_minimal()
```

