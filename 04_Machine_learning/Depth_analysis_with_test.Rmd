---
title: "Depth_analysis_with_test"
author: "Maria Popescu"
date: "2025-08-16"
output: html_document
---
This for final machine learning analysis. 

before running this script first run
01_DataDownload
03_Datawrangling: then go through all the files within chronologically
then you can run this script

1. prep data for RandomForest
2. tune model for RandomForest
3. run Random Forest
4. visualize SHAP values

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load the packages that you need
```{r}
library(randomForest)
library(missForest)
library(caret)
library(future)
library(here)
```

This data frame has predictor values for DCM depth as well as DCM magnitude. 
Need to split these up for two different analysis

```{r}
full_weekly_data <- read.csv(here("CSVs", "full_weekly_data.csv"))

#print(colnames(full_weekly_data_clean))
depth_analysis <- full_weekly_data |>
  #select(-ends_with("max_val"), -ends_with("min_val"), -ends_with("range"), 
   #      -max_conc, -totals_mean, -totals_med, -N_at_DCM, -Week)|>
  select(Date, DCM_depth, PZ, WaterLevel_m, depth_TFe_mgL_min, depth_TFe_mgL_max, schmidt_stability, avg_airtemp_lagged, Precip_avg_lagged, PAR_umolm2s_Weekly_Avg_lagged, depth_np_ratio_min)
```

Split into training and testing

```{r}
library(caret)

set.seed(123)

# Sort by Date
RF_depth_analysis <- depth_analysis[order(depth_analysis$Date), ]

# Example: use 70% earliest data for training, 30% most recent for testing
train_index <- 1:floor(0.7 * nrow(RF_depth_analysis))

train_data <- RF_depth_analysis[train_index, ]
test_data  <- RF_depth_analysis[-train_index, ]
```



Tidy up the frame for depth analysis
```{r}
# Remove non-numeric columns (excluding Date, Depth_m, Year, etc.)
non_numeric_columns <- sapply(depth_analysis, function(x) !is.numeric(x) & !is.factor(x))
final_no_non_numeric <- depth_analysis |>
  select(-which(non_numeric_columns)) 

# Replace Inf and NaN with NA in all numeric columns
final_no_non_numeric <- final_no_non_numeric %>%
  mutate(across(where(is.numeric), ~ ifelse(is.infinite(.) | is.nan(.), NA, .)))

# Remove columns with more than 75% NA values
final_data_no_na <- final_no_non_numeric %>%
  select(where(~ mean(is.na(.)) <= 0.25))  # Keep columns with ≤ 25% NA

# Remove remaining rows with any NA values
RF_depth_analysis <- final_data_no_na %>%
  na.omit()

write.csv(RF_depth_analysis, here("CSVs", "RF_depth_analysis.csv"), row.names = FALSE)
```


check to see how much is actually going into the analysis
```{r}
test<-depth_analysis |>
    select(where(~ mean(is.na(.)) <= 0.25))  # Keep columns with ≤ 25% NA

RF_frame_w_dates <- test %>%
  na.omit()
 
RF_frame_w_dates %>%
  count(year(Date)) %>%
  print() 
  
```




