---
title: "Depth_analysis_with_test"
author: "Maria Popescu"
date: "2025-08-16"
output: html_document
---
THIS VERSION HAS VERY AWFUL OUTPUT IGNORE THIS ONE


before running this script first run
01_DataDownload
03_Datawrangling: then go through all the files within chronologically
then you can run this script

1. now we have determined what the most important drivers are from the Depth_analysis.Rmd. Water level and photic zone are the most important drivers, I will use 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load the packages that you need
```{r}
library(randomForest)
library(missForest)
library(caret)
library(future)
library(here)
```

This data frame has predictor values for DCM depth as well as DCM magnitude. 
Need to split these up for two different analysis

```{r}
full_weekly_data <- read.csv(here("CSVs", "full_weekly_data.csv"))

#print(colnames(full_weekly_data_clean))
depth_analysis <- full_weekly_data |>
  #select(-ends_with("max_val"), -ends_with("min_val"), -ends_with("range"), 
   #      -max_conc, -totals_mean, -totals_med, -N_at_DCM, -Week)|>
  #select(Date, DCM_depth, PZ, WaterLevel_m)
    select(Date, DCM_depth, PZ, WaterLevel_m, depth_TFe_mgL_min, depth_TFe_mgL_max, schmidt_stability, avg_airtemp_lagged, Precip_avg_lagged, PAR_umolm2s_Weekly_Avg_lagged, depth_np_ratio_min)

```

Tidy up the frame for depth analysis
```{r}
# Remove non-numeric columns (excluding Date, Depth_m, Year, etc.)
non_numeric_columns <- sapply(depth_analysis, function(x) !is.numeric(x) & !is.factor(x))
cols_to_drop <- names(depth_analysis)[non_numeric_columns & names(depth_analysis) != "Date"]

final_no_non_numeric <- depth_analysis |>
  select(-all_of(cols_to_drop))

# Replace Inf and NaN with NA in all numeric columns
final_no_non_numeric <- final_no_non_numeric %>%
  mutate(across(where(is.numeric), ~ ifelse(is.infinite(.) | is.nan(.), NA, .)))

# Remove columns with more than 75% NA values
final_data_no_na <- final_no_non_numeric %>%
  select(where(~ mean(is.na(.)) <= 0.25))  # Keep columns with â‰¤ 25% NA

# Remove remaining rows with any NA values
RF_depth_analysis <- final_data_no_na %>%
  na.omit()

#write.csv(RF_depth_analysis, here("CSVs", "RF_depth_analysis.csv"), row.names = FALSE)
```


Split into training and testing

```{r}
library(caret)

set.seed(123)

# Sort by Date
RF_depth_analysis <- RF_depth_analysis[order(RF_depth_analysis$Date), ]

# Example: use 70% earliest data for training, 30% most recent for testing
train_index <- 1:floor(0.85 * nrow(RF_depth_analysis))

train_data <- RF_depth_analysis[train_index, ]
test_data  <- RF_depth_analysis[-train_index, ]

# When modeling, drop Date (since RF can't use it directly)
train_model_data <- train_data %>% select(-Date)
test_model_data  <- test_data %>% select(-Date)

```

time-series CV
```{r}
# Cross-validation on training set only
control <- trainControl(method = "cv", number = 10, savePredictions = "final")

n_pred <- ncol(train_model_data) - 1

tune_grid <- expand.grid(
  mtry = seq(1, n_pred, by = 1),
  splitrule = c("variance", "extratrees"),
  min.node.size = c(1, 5, 10)
)

rf_caret <- train(
  DCM_depth ~ .,
  data = train_model_data,
  method = "ranger",
  metric = "RMSE",
  trControl = control,
  tuneGrid = tune_grid,
  num.trees = 1000
)
```

```{r}
# Final evaluation on held-out 15%
pred_test <- predict(rf_caret, newdata = test_model_data)
postResample(pred_test, test_model_data$DCM_depth)
```


```{r}
# Predict on test set
preds <- predict(rf_caret$finalModel, newdata = test_data)

# Use variability across trees to estimate uncertainty
all_tree_preds <- predict(rf_caret$finalModel, newdata = test_data, predict.all = TRUE)
pred_matrix <- all_tree_preds$individual
pred_mean <- rowMeans(pred_matrix)
pred_sd   <- apply(pred_matrix, 1, sd)

plot_df <- data.frame(
  Date = test_data$Date,
  Observed = test_data$DCM_depth,
  Predicted = pred_mean,
  Lower = pred_mean - 1.96 * pred_sd,
  Upper = pred_mean + 1.96 * pred_sd
)

library(ggplot2)
ggplot(plot_df, aes(x = Date)) +
  geom_line(aes(y = Observed, color = "Observed"), size = 1) +
  geom_line(aes(y = Predicted, color = "Predicted"), size = 1, linetype = "dashed") +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), fill = "blue", alpha = 0.2) +
  labs(title = "Random Forest Forecast with Uncertainty",
       y = "DCM Depth",
       color = "") +
  theme_minimal()
```

